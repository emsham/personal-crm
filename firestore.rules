rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns this document path
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if a field is a valid string (non-empty, with max length)
    function isValidString(field) {
      return field is string && field.size() > 0 && field.size() <= 1000;
    }

    // Check if a field is a valid optional string (can be empty, with max length)
    function isValidOptionalString(field) {
      return field is string && field.size() <= 5000;
    }

    // Check if a field is a valid long text field (notes, etc.)
    function isValidLongText(field) {
      return field is string && field.size() <= 50000;
    }

    // Check if tags array is valid (limited size)
    function isValidTags(tags) {
      return tags is list && tags.size() <= 50;
    }

    // Check if related contacts array is valid (limited size)
    function isValidRelatedContacts(contacts) {
      return contacts is list && contacts.size() <= 100;
    }

    // Check if status is valid
    function isValidStatus(status) {
      return status in ['active', 'drifting', 'lost'];
    }

    // Check if priority is valid
    function isValidPriority(priority) {
      return priority in ['low', 'medium', 'high'];
    }

    // Check if frequency is valid
    function isValidFrequency(frequency) {
      return frequency in ['none', 'daily', 'weekly', 'biweekly', 'monthly', 'quarterly', 'yearly'];
    }

    // Check if interaction type is valid
    function isValidInteractionType(type) {
      return type in ['Meeting', 'Call', 'Email', 'Coffee', 'Event', 'Other'];
    }

    // ============================================
    // Timestamp Validation Functions
    // ============================================

    // Check if createdAt is a valid server timestamp (within 60 seconds of request time)
    // This prevents clients from backdating document creation
    function isValidCreatedAt() {
      return request.resource.data.createdAt == request.time;
    }

    // Check if updatedAt is a valid server timestamp
    function isValidUpdatedAt() {
      return request.resource.data.updatedAt == request.time;
    }

    // Check if createdAt is preserved on update (not modified)
    function createdAtUnchanged() {
      return !('createdAt' in request.resource.data) ||
             request.resource.data.createdAt == resource.data.createdAt;
    }

    // ============================================
    // Date Format Validation Functions
    // ============================================

    // Check if a date string is in valid ISO format (YYYY-MM-DD or ISO timestamp)
    // Basic validation: must be string between 10-30 chars (covers dates and timestamps)
    function isValidDateString(dateStr) {
      return dateStr is string && dateStr.size() >= 10 && dateStr.size() <= 30;
    }

    // Check if a date string is in MM-DD format (for birthdays, important dates)
    function isValidMonthDayString(dateStr) {
      return dateStr is string && dateStr.size() == 5;
    }

    // ============================================
    // Encryption Version Validation
    // ============================================

    // Check if encryption version is valid (must be positive integer, current max is 1)
    function isValidEncryptionVersion(version) {
      return version is int && version >= 1 && version <= 10;
    }

    // ============================================
    // User Document Rules
    // ============================================

    // Block access to root users collection - only subcollections allowed
    match /users/{userId} {
      allow read, write: if false;

      // ============================================
      // Contacts Collection
      // ============================================
      match /contacts/{contactId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && isValidString(request.resource.data.firstName)
          && isValidOptionalString(request.resource.data.lastName)
          && isValidOptionalString(request.resource.data.email)
          && isValidOptionalString(request.resource.data.phone)
          && isValidOptionalString(request.resource.data.company)
          && isValidOptionalString(request.resource.data.position)
          && isValidTags(request.resource.data.tags)
          && isValidStatus(request.resource.data.status)
          && isValidRelatedContacts(request.resource.data.relatedContactIds);

        allow update: if isOwner(userId)
          && (!('firstName' in request.resource.data) || isValidString(request.resource.data.firstName))
          && (!('lastName' in request.resource.data) || isValidOptionalString(request.resource.data.lastName))
          && (!('email' in request.resource.data) || isValidOptionalString(request.resource.data.email))
          && (!('phone' in request.resource.data) || isValidOptionalString(request.resource.data.phone))
          && (!('company' in request.resource.data) || isValidOptionalString(request.resource.data.company))
          && (!('position' in request.resource.data) || isValidOptionalString(request.resource.data.position))
          && (!('status' in request.resource.data) || isValidStatus(request.resource.data.status))
          && (!('tags' in request.resource.data) || isValidTags(request.resource.data.tags))
          && (!('relatedContactIds' in request.resource.data) || isValidRelatedContacts(request.resource.data.relatedContactIds));

        allow delete: if isOwner(userId);
      }

      // ============================================
      // Interactions Collection
      // ============================================
      match /interactions/{interactionId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && isValidString(request.resource.data.contactId)
          && isValidString(request.resource.data.date)
          && isValidInteractionType(request.resource.data.type)
          && isValidLongText(request.resource.data.notes);

        allow update: if isOwner(userId)
          && (!('type' in request.resource.data) || isValidInteractionType(request.resource.data.type))
          && (!('notes' in request.resource.data) || isValidLongText(request.resource.data.notes))
          && (!('contactId' in request.resource.data) || isValidString(request.resource.data.contactId))
          && (!('date' in request.resource.data) || isValidString(request.resource.data.date));

        allow delete: if isOwner(userId);
      }

      // ============================================
      // Tasks Collection
      // ============================================
      match /tasks/{taskId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && isValidString(request.resource.data.title)
          && request.resource.data.completed is bool
          && isValidPriority(request.resource.data.priority)
          && isValidFrequency(request.resource.data.frequency);

        allow update: if isOwner(userId)
          && (!('title' in request.resource.data) || isValidString(request.resource.data.title))
          && (!('priority' in request.resource.data) || isValidPriority(request.resource.data.priority))
          && (!('frequency' in request.resource.data) || isValidFrequency(request.resource.data.frequency))
          && (!('completed' in request.resource.data) || request.resource.data.completed is bool);

        allow delete: if isOwner(userId);
      }

      // ============================================
      // Chat Sessions Collection
      // ============================================
      match /chatSessions/{sessionId} {
        allow read: if isOwner(userId);

        // Limit messages array to prevent storage abuse (1000 messages max)
        allow create: if isOwner(userId)
          && isValidString(request.resource.data.title)
          && request.resource.data.messages is list
          && request.resource.data.messages.size() <= 1000;

        allow update: if isOwner(userId)
          && (!('title' in request.resource.data) || isValidString(request.resource.data.title))
          && (!('messages' in request.resource.data) || (request.resource.data.messages is list && request.resource.data.messages.size() <= 1000));

        allow delete: if isOwner(userId);
      }

      // ============================================
      // API Keys Collection (Encrypted)
      // Stores encrypted LLM API keys for cross-platform sync
      // ============================================
      match /apiKeys/{keyId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
          && isValidString(request.resource.data.providerId)
          && isValidString(request.resource.data.encryptedKey)
          && isValidString(request.resource.data.iv)
          && isValidEncryptionVersion(request.resource.data.encryptionVersion)
          && isValidCreatedAt()
          && isValidUpdatedAt();

        allow update: if isOwner(userId)
          && isValidString(request.resource.data.encryptedKey)
          && isValidString(request.resource.data.iv)
          && isValidEncryptionVersion(request.resource.data.encryptionVersion)
          && createdAtUnchanged()
          && isValidUpdatedAt();

        allow delete: if isOwner(userId);
      }

      // ============================================
      // User Profile/Settings
      // Single document per user - no wildcard nesting allowed
      // ============================================
      match /profile/{docId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId)
          && request.resource.data.keys().size() <= 50;
        allow delete: if isOwner(userId);
      }

      match /settings/{docId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId)
          && request.resource.data.keys().size() <= 50;
        allow delete: if isOwner(userId);
      }
    }

    // ============================================
    // Deny all other access by default
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
